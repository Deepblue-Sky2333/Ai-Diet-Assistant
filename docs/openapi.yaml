openapi: 3.0.3
info:
  title: AI Diet Assistant API
  description: |
    RESTful API for AI-powered diet planning and nutrition management system.
    
    ## Features
    - JWT-based authentication
    - Food inventory management
    - Meal tracking and recording
    - AI-powered meal plan generation
    - Nutrition analysis and statistics
    - AI conversation flow management with message proxy
    
    ## Authentication
    Most endpoints require JWT Bearer token authentication.
    Include the token in the Authorization header: `Bearer {token}`
    
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:9090/api/v1
    description: Development server
  - url: https://api.yourdomain.com/api/v1
    description: Production server

tags:
  - name: Authentication
    description: User authentication and authorization
  - name: Foods
    description: Food inventory management
  - name: Meals
    description: Meal records management
  - name: Plans
    description: Meal plans management
  - name: Conversations
    description: AI conversation flow management
  - name: Messages
    description: AI message proxy and history
  - name: Nutrition
    description: Nutrition analysis and statistics
  - name: Dashboard
    description: Dashboard data
  - name: Settings
    description: User settings and preferences

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from login endpoint

  schemas:
    Error:
      type: object
      properties:
        code:
          type: integer
          example: 40001
        message:
          type: string
          example: "Invalid parameters"
        error:
          type: string
          example: "Detailed error message"
        timestamp:
          type: integer
          format: int64
          example: 1699999999
    
    SuccessResponse:
      type: object
      properties:
        code:
          type: integer
          example: 0
        message:
          type: string
          example: "success"
        timestamp:
          type: integer
          format: int64
          example: 1699999999
    
    Pagination:
      type: object
      properties:
        page:
          type: integer
          example: 1
        page_size:
          type: integer
          example: 20
        total:
          type: integer
          example: 100
        total_pages:
          type: integer
          example: 5
    
    LoginRequest:
      type: object
      required:
        - username
        - password
      properties:
        username:
          type: string
          example: "user"
        password:
          type: string
          format: password
          example: "password123"
    
    TokenResponse:
      allOf:
        - $ref: '#/components/schemas/SuccessResponse'
        - type: object
          properties:
            data:
              type: object
              properties:
                access_token:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                refresh_token:
                  type: string
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                expires_in:
                  type: integer
                  example: 900
                user:
                  type: object
                  properties:
                    id:
                      type: integer
                      example: 1
                    username:
                      type: string
                      example: "user"
    
    NutritionData:
      type: object
      properties:
        protein:
          type: number
          format: float
          example: 31.0
        carbs:
          type: number
          format: float
          example: 0.0
        fat:
          type: number
          format: float
          example: 3.6
        fiber:
          type: number
          format: float
          example: 0.0
        calories:
          type: number
          format: float
          example: 165.0
    
    Food:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        user_id:
          type: integer
          format: int64
          example: 1
        name:
          type: string
          example: "Chicken Breast"
        category:
          type: string
          enum: [meat, vegetable, fruit, grain, other]
          example: "meat"
        price:
          type: number
          format: float
          example: 12.99
        unit:
          type: string
          example: "g"
        protein:
          type: number
          format: float
          example: 31.0
        carbs:
          type: number
          format: float
          example: 0.0
        fat:
          type: number
          format: float
          example: 3.6
        fiber:
          type: number
          format: float
          example: 0.0
        calories:
          type: number
          format: float
          example: 165.0
        available:
          type: boolean
          example: true
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    
    MealFood:
      type: object
      properties:
        food_id:
          type: integer
          format: int64
          example: 1
        name:
          type: string
          example: "Chicken Breast"
        amount:
          type: number
          format: float
          example: 200
        unit:
          type: string
          example: "g"
    
    Meal:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        user_id:
          type: integer
          format: int64
          example: 1
        meal_date:
          type: string
          format: date
          example: "2024-01-01"
        meal_type:
          type: string
          enum: [breakfast, lunch, dinner, snack]
          example: "breakfast"
        foods:
          type: array
          items:
            $ref: '#/components/schemas/MealFood'
        nutrition:
          $ref: '#/components/schemas/NutritionData'
        notes:
          type: string
          example: "Healthy breakfast"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    Plan:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        user_id:
          type: integer
          format: int64
          example: 1
        plan_date:
          type: string
          format: date
          example: "2024-01-02"
        meal_type:
          type: string
          enum: [breakfast, lunch, dinner, snack]
          example: "breakfast"
        foods:
          type: array
          items:
            $ref: '#/components/schemas/MealFood'
        nutrition:
          $ref: '#/components/schemas/NutritionData'
        status:
          type: string
          enum: [pending, completed, skipped]
          example: "pending"
        ai_reasoning:
          type: string
          example: "High protein breakfast to start your day"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    ConversationFlow:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        user_id:
          type: integer
          format: int64
          example: 1
        title:
          type: string
          maxLength: 200
          example: "Meal planning discussion"
        is_favorited:
          type: boolean
          example: false
        message_count:
          type: integer
          example: 5
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    
    Message:
      type: object
      properties:
        id:
          type: integer
          format: int64
          example: 1
        conversation_id:
          type: integer
          format: int64
          example: 1
        role:
          type: string
          enum: [user, assistant]
          example: "user"
        content:
          type: string
          example: "What should I eat for dinner?"
        created_at:
          type: string
          format: date-time
    
    CreateConversationRequest:
      type: object
      properties:
        title:
          type: string
          maxLength: 200
          example: "New conversation"
    
    UpdateConversationRequest:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          maxLength: 200
          example: "Updated conversation title"
    
    SendMessageRequest:
      type: object
      required:
        - content
      properties:
        content:
          type: string
          maxLength: 10485760
          example: "What should I eat for dinner?"
    
    ExportConversationsRequest:
      type: object
      required:
        - conversation_ids
      properties:
        conversation_ids:
          type: array
          items:
            type: integer
            format: int64
          example: [1, 2, 3]

paths:
  /auth/login:
    post:
      tags:
        - Authentication
      summary: User login
      description: Authenticate user and receive access tokens
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Get new access token using refresh token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refresh_token
              properties:
                refresh_token:
                  type: string
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /auth/logout:
    post:
      tags:
        - Authentication
      summary: User logout
      description: Invalidate current tokens
      operationId: logout
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Logout successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
  
  /foods:
    get:
      tags:
        - Foods
      summary: List food items
      description: Get paginated list of food items with optional filtering
      operationId: listFoods
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
        - name: category
          in: query
          schema:
            type: string
            enum: [meat, vegetable, fruit, grain, other]
        - name: available
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: List of foods
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Food'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
    
    post:
      tags:
        - Foods
      summary: Create food item
      description: Add a new food item to inventory
      operationId: createFood
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - category
              properties:
                name:
                  type: string
                category:
                  type: string
                  enum: [meat, vegetable, fruit, grain, other]
                price:
                  type: number
                unit:
                  type: string
                protein:
                  type: number
                carbs:
                  type: number
                fat:
                  type: number
                fiber:
                  type: number
                calories:
                  type: number
                available:
                  type: boolean
      responses:
        '201':
          description: Food created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Food'

  
  /foods/{id}:
    get:
      tags:
        - Foods
      summary: Get food item
      description: Get food item by ID
      operationId: getFood
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Food item details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Food'
        '404':
          description: Food not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    put:
      tags:
        - Foods
      summary: Update food item
      description: Update existing food item
      operationId: updateFood
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                category:
                  type: string
                price:
                  type: number
                available:
                  type: boolean
      responses:
        '200':
          description: Food updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Food'
    
    delete:
      tags:
        - Foods
      summary: Delete food item
      description: Remove food item from inventory
      operationId: deleteFood
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Food deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
  
  /meals:
    get:
      tags:
        - Meals
      summary: List meal records
      description: Get paginated list of meal records
      operationId: listMeals
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
        - name: date
          in: query
          schema:
            type: string
            format: date
        - name: meal_type
          in: query
          schema:
            type: string
            enum: [breakfast, lunch, dinner, snack]
      responses:
        '200':
          description: List of meals
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Meal'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
    
    post:
      tags:
        - Meals
      summary: Create meal record
      description: Add a new meal record
      operationId: createMeal
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - meal_date
                - meal_type
                - foods
              properties:
                meal_date:
                  type: string
                  format: date
                meal_type:
                  type: string
                  enum: [breakfast, lunch, dinner, snack]
                foods:
                  type: array
                  items:
                    type: object
                    properties:
                      food_id:
                        type: integer
                      amount:
                        type: number
                notes:
                  type: string
      responses:
        '201':
          description: Meal created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Meal'
  
  /plans/generate:
    post:
      tags:
        - Plans
      summary: Generate meal plans
      description: Generate AI-powered meal plans for future days
      operationId: generatePlans
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                days:
                  type: integer
                  default: 2
                  example: 2
                preferences:
                  type: string
                  example: "I prefer low-carb meals"
      responses:
        '200':
          description: Plans generated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Plan'
  
  /conversations:
    get:
      tags:
        - Conversations
      summary: List conversation flows
      description: Get paginated list of conversation flows with optional filtering
      operationId: listConversations
      security:
        - BearerAuth: []
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
        - name: is_favorited
          in: query
          schema:
            type: boolean
        - name: sort_by
          in: query
          schema:
            type: string
            enum: [created_at, updated_at]
            default: updated_at
        - name: sort_order
          in: query
          schema:
            type: string
            enum: [asc, desc]
            default: desc
      responses:
        '200':
          description: List of conversation flows
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/ConversationFlow'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
    
    post:
      tags:
        - Conversations
      summary: Create conversation flow
      description: Create a new conversation flow
      operationId: createConversation
      security:
        - BearerAuth: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateConversationRequest'
      responses:
        '201':
          description: Conversation created successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ConversationFlow'
        '403':
          description: Recent conversation limit reached
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /conversations/search:
    get:
      tags:
        - Conversations
      summary: Search conversation flows
      description: Search conversation flows by keyword in title
      operationId: searchConversations
      security:
        - BearerAuth: []
      parameters:
        - name: keyword
          in: query
          required: true
          schema:
            type: string
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 20
        - name: is_favorited
          in: query
          schema:
            type: boolean
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/ConversationFlow'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
  
  /conversations/export:
    post:
      tags:
        - Conversations
      summary: Export multiple conversations
      description: Export multiple conversation flows to JSON format
      operationId: exportConversations
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ExportConversationsRequest'
      responses:
        '200':
          description: Conversations exported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                    example: "1.0"
                  exported_at:
                    type: string
                    format: date-time
                  conversations:
                    type: array
                    items:
                      type: object
  
  /conversations/{id}:
    get:
      tags:
        - Conversations
      summary: Get conversation flow
      description: Get conversation flow by ID
      operationId: getConversation
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Conversation flow details
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ConversationFlow'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    put:
      tags:
        - Conversations
      summary: Update conversation title
      description: Update the title of a conversation flow
      operationId: updateConversationTitle
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateConversationRequest'
      responses:
        '200':
          description: Conversation updated successfully
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ConversationFlow'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    delete:
      tags:
        - Conversations
      summary: Delete conversation flow
      description: Delete a conversation flow and all its messages
      operationId: deleteConversation
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Conversation deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /conversations/{id}/favorite:
    post:
      tags:
        - Conversations
      summary: Favorite conversation
      description: Mark a conversation flow as favorited
      operationId: favoriteConversation
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Conversation favorited successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '403':
          description: Favorite limit reached (max 100)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    delete:
      tags:
        - Conversations
      summary: Unfavorite conversation
      description: Remove favorite status from a conversation flow
      operationId: unfavoriteConversation
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Conversation unfavorited successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /conversations/{id}/export:
    get:
      tags:
        - Conversations
      summary: Export conversation
      description: Export a single conversation flow to JSON format
      operationId: exportConversation
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: Conversation exported successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  version:
                    type: string
                    example: "1.0"
                  exported_at:
                    type: string
                    format: date-time
                  conversations:
                    type: array
                    items:
                      type: object
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /conversations/{id}/messages:
    get:
      tags:
        - Messages
      summary: Get conversation messages
      description: Get all messages for a conversation flow
      operationId: getMessages
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
        - name: page
          in: query
          schema:
            type: integer
            default: 1
        - name: page_size
          in: query
          schema:
            type: integer
            default: 50
      responses:
        '200':
          description: List of messages
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/Message'
                      pagination:
                        $ref: '#/components/schemas/Pagination'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    
    post:
      tags:
        - Messages
      summary: Send message
      description: Send a message to external AI service and store the conversation
      operationId: sendMessage
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '200':
          description: Message sent and AI response received
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/Message'
        '400':
          description: Invalid request or message too large
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Conversation not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '502':
          description: External AI service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  
  /nutrition/daily/{date}:
    get:
      tags:
        - Nutrition
      summary: Get daily nutrition
      description: Get nutrition statistics for a specific date
      operationId: getDailyNutrition
      security:
        - BearerAuth: []
      parameters:
        - name: date
          in: path
          required: true
          schema:
            type: string
            format: date
      responses:
        '200':
          description: Daily nutrition statistics
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          date:
                            type: string
                            format: date
                          nutrition:
                            $ref: '#/components/schemas/NutritionData'
                          meal_count:
                            type: integer
  
  /dashboard:
    get:
      tags:
        - Dashboard
      summary: Get dashboard data
      description: Get comprehensive dashboard data
      operationId: getDashboard
      security:
        - BearerAuth: []
      responses:
        '200':
          description: Dashboard data
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/SuccessResponse'
                  - type: object
                    properties:
                      data:
                        type: object
                        properties:
                          recent_meals:
                            type: array
                            items:
                              $ref: '#/components/schemas/Meal'
                          upcoming_plans:
                            type: array
                            items:
                              $ref: '#/components/schemas/Plan'
