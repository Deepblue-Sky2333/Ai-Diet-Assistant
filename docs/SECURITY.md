# 安全最佳实践 / Security Best Practices

本文档提供应用层安全配置和最佳实践指南。

**注意：** 网络层安全（HTTPS、TLS、防火墙等）由 Nginx 反向代理处理，本文档仅涵盖应用层安全。

## 🔐 密钥管理

### 1. 生成安全密钥

**推荐方式：使用安装脚本**

```bash
./scripts/install.sh
```

安装脚本会自动生成：
- JWT 密钥：48 字节 base64 编码
- AES 加密密钥：32 字节强随机密钥

**手动生成（不推荐）：**

```bash
# JWT 密钥
openssl rand -base64 48

# AES 加密密钥
openssl rand -base64 32 | head -c 32
```

### 2. 密钥存储

- ✅ 将密钥存储在 `.env` 文件中
- ✅ 设置文件权限为 600（仅所有者可读写）
- ✅ 确保 `.env` 在 `.gitignore` 中
- ❌ 永不提交密钥到版本控制系统
- ❌ 不要在代码中硬编码密钥

### 3. 密钥轮换

定期更换密钥以提高安全性：

```bash
# 1. 生成新密钥
NEW_JWT_SECRET=$(openssl rand -base64 48)

# 2. 更新 .env 文件
# 3. 重启服务
# 4. 所有用户需要重新登录
```

## 🔒 密码安全

### 密码策略

系统使用 bcrypt 加密密码（cost=12）：

- ✅ 密码不以明文存储
- ✅ 每个密码使用唯一的 salt
- ✅ 计算成本高，防止暴力破解

### 登录保护

- ✅ 登录失败限流（5次/15分钟）
- ✅ 账户锁定机制
- ✅ 登录日志记录

### 密码修改

修改密码后：
- ✅ 所有旧令牌自动失效
- ✅ 用户需要重新登录
- ✅ 记录密码修改日志

## 🛡️ 数据加密

### 敏感数据加密

系统使用 AES-256-GCM 加密敏感数据：

- ✅ AI API 密钥
- ✅ 其他敏感配置

## 🚦 访问控制

### JWT 认证

- ✅ Access Token 有效期：1 小时
- ✅ Refresh Token 有效期：7 天
- ✅ Token 自动刷新机制
- ✅ 登出后 Token 立即失效

### 令牌黑名单

使用 Redis 实现令牌黑名单：

- ✅ 登出后令牌加入黑名单
- ✅ 密码修改后所有令牌失效
- ✅ 自动过期清理

## 🔍 输入验证

### 防止注入攻击

- ✅ 使用参数化查询（防止 SQL 注入）
- ✅ 输入清理中间件（防止 XSS）
- ✅ 请求体大小限制（10MB）
- ✅ 文件类型验证

### 数据验证

- ✅ 使用 go-playground/validator
- ✅ 前后端双重验证
- ✅ 类型检查和范围验证

## 📊 日志和监控

### 安全日志

记录以下安全事件：

- ✅ 登录成功/失败
- ✅ 密码修改
- ✅ 认证失败
- ✅ 异常访问

### 日志保护

- ✅ 自动清理敏感信息
- ✅ 密码不记录到日志
- ✅ 数据库连接字符串脱敏
- ✅ 文件路径清理

## 🚨 安全检查清单

### 部署前检查

- [ ] 所有密钥已更换为生产密钥
- [ ] 数据库密码强度足够
- [ ] Redis 已启用（生产环境）
- [ ] 日志级别设置为 info 或 warn
- [ ] 定期备份已设置

### 定期检查

- [ ] 检查异常登录日志
- [ ] 更新依赖包
- [ ] 审查访问日志
- [ ] 测试备份恢复
- [ ] 检查磁盘空间

## 🆘 安全事件响应

### 发现安全问题

1. **立即行动**
   - 隔离受影响的系统
   - 更换所有密钥
   - 强制所有用户重新登录

2. **调查分析**
   - 检查日志文件
   - 确定影响范围
   - 记录事件详情

3. **修复和恢复**
   - 修复安全漏洞
   - 恢复服务
   - 通知受影响用户

4. **事后总结**
   - 分析根本原因
   - 改进安全措施
   - 更新文档

## � 相关资源

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Go Security Checklist](https://github.com/Checkmarx/Go-SCP)
- [JWT Best Practices](https://tools.ietf.org/html/rfc8725)

## 📚 相关文档

- [项目 README](../README.md) - 项目概述和安装指南
- [API 文档](api/README.md) - 完整 API 接口说明
- [Nginx 配置](NGINX_CONFIGURATION.md) - Nginx 反向代理配置指南
